// schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// 1. Enums
// ==========================================

enum Role {
  ADMIN
  SUPERVISOR
  USER
}

enum Department {
  IQC
  WAREHOUSE
  PRODUCTION
  PLANNING
  PURCHASING
}

// Simplified for Inbound-only system
enum InboundStatus {
  ARRIVED                  // 0. งานเข้าใหม่ (ยังไม่มี Tag/Tracking)
  PENDING                  // 1. รอรับของ (สร้าง Tag แล้ว รอ Scan)
  IQC_WAITING              // 2. รับของแล้ว รอ IQC ตรวจ
  IQC_IN_PROGRESS          // 3. กำลังตรวจสอบ
  IQC_PASSED_WAITING_STOCK // 4. ตรวจผ่าน รอ Warehouse เก็บเข้า Stock
  COMPLETED                // 5. เสร็จสมบูรณ์ เก็บเข้า Stock แล้ว
  REJECTED                 // x. ตรวจไม่ผ่าน
  CANCELLED                // x. ยกเลิก
}

// Reserved for future outbound/picking features
enum OutboundStatus {
  PENDING
  PICKING_IN_PROGRESS
  PICKED_WAITING_DELIVERY
  COMPLETED
  CANCELLED
}

// ==========================================
// 2. User & System
// ==========================================

model User {
  id        String     @id @default(uuid())
  username  String     @unique
  password  String
  email     String?
  role      Role       @default(USER)
  section   Department @default(IQC)
  isActive  Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  sessions      Session[]
  assignedInboundTasks InboundTask[] @relation("AssignedUser")
  notifications Notification[]
  
  @@map("users")
}

model Session {
  id        String   @id
  userId    String
  token     String   @unique
  expiresAt DateTime
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@map("sessions")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String?
  type      String   // INFO, WARNING, ERROR
  title     String
  message   String?
  data      Json?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])
  @@map("notifications")
}

// ==========================================
// 3. Master Data
// ==========================================

model Supplier {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  contactName String?
  email       String?
  phone       String?
  address     String?
  country     String?
  taxId       String?
  
  parts       Part[]   @relation("PartSupplier")
  poList      PurchaseOrder[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  @@map("suppliers")
}

model Part {
  id          String   @id @default(uuid())
  partNo      String   @unique
  name        String?
  spec        String?
  drawingNo   String?
  unit        String   @default("PCS")
  safetyStock Float    @default(0)
  icon        String?
  
  suppliers      Supplier[] @relation("PartSupplier")
  stocks         Stock[]
  inboundTasks   InboundTask[]
  outboundTasks  OutboundTask[]
  poItems        PurchaseOrderItem[]
  bomItems       BOMItem[]
  movements      Movement[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  @@index([partNo])
  @@map("master_parts")
}

// ==========================================
// 4. Inventory
// ==========================================

model Stock {
  id        String   @id @default(uuid())
  partId    String
  location  String
  quantity  Float    @default(0)
  updatedAt DateTime @updatedAt
  part      Part     @relation(fields: [partId], references: [id])
  @@unique([partId, location])
  @@map("inventory_stocks")
}

model Movement {
  id          String   @id @default(uuid())
  partId      String
  type        String
  qty         Float
  docRef      String?
  createdAt   DateTime @default(now())
  part        Part     @relation(fields: [partId], references: [id])
  @@map("inventory_movements")
}

// ==========================================
// 5. Inbound Task (IQC Inspection)
// ==========================================

model InboundTask {
  id          String        @id @default(uuid())
  status      InboundStatus @default(PENDING)
  
  // --- Tagging ---
  tagNo       String?       @unique  // IQC Tag Number (printed on label)
  
  // --- Invoice/PO Document ---
  invoiceNo   String                  // INV_NO from INVINCOM
  poNo        String?                 // PO_NO from INVINCOM
  vendor      String                  // VENDOR_NAME from INVINCOM
  
  // --- Part Info ---
  partId      String?
  part        Part?         @relation(fields: [partId], references: [id])
  partNo      String                  // ITEM_NO (snapshot, ไม่ต้องพึ่ง Part table)
  partName    String?                 // ITEM_NAME
  
  // --- Traceability ---
  lotNo       String?
  rev         String?
  mfgDate     DateTime?
  
  // --- Quantity ---
  planQty     Float                   // REPLY_QTY from invoice
  actualQty   Float         @default(0)  // Actual quantity after inspection
  
  // --- IQC Inspection Flow ---
  receivedBy    String?               // Who received at warehouse
  receivedAt    DateTime?             // When received at warehouse
  receiverNote  String?
  
  assignedTo    String?               // IQC inspector assigned
  assignee      User?       @relation("AssignedUser", fields: [assignedTo], references: [id])
  startedAt     DateTime?             // When IQC started inspection
  finishedAt    DateTime?             // When IQC finished
  
  // --- Warehouse Integration ---
  targetLocation String?              // Where to store after passing IQC
  
  // --- Meta ---
  dueDate       DateTime?
  spec          String?     // SPEC from API
  drawingNo     String?     // DRAW from API
  unit          String?     // REPLY_UNIT from API
  remark        String?     // REMARK from API
  taxInvoice    String?     // TAX_INVOICE from API
  
  // --- Additional PBASS Fields ---
  plant         String?     // PLAC from API
  division      String?     // DIVI from API
  vendorCode    String?     // VENDOR (code) from API
  poDate        DateTime?   // PO_DATE from API
  unitPrice     Float?      // REPLY_UP from API
  amount        Float?      // REPLY_AMT from API
  currency      String?     // REPLY_CUR from API
  
  isUrgent      Boolean     @default(false)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  // --- Sampling Details ---
  samplingType  String?     // Normal, Reduced, Tightened
  aql           String?     // 0.65, 1.0, 1.5, etc.
  totalSampling Int?        // Calculated sample size
  
  // --- Relations ---
  inspection    InspectionResult?
  poItemId      String?
  poItem        PurchaseOrderItem? @relation(fields: [poItemId], references: [id])
  
  @@unique([invoiceNo, partNo, vendor])
  @@index([tagNo])
  @@index([invoiceNo])
  @@index([status])
  @@index([vendor])
  @@map("inbound_tasks")
}

// Reserved for future outbound/picking system
model OutboundTask {
  id          String         @id @default(uuid())
  status      OutboundStatus @default(PENDING)
  moNo        String                   // Manufacturing Order Number
  line        String?                  // Production Line
  
  partId      String?
  part        Part?          @relation(fields: [partId], references: [id])
  partNo      String
  
  bomItemId   String?
  bomItem     BOMItem?       @relation(fields: [bomItemId], references: [id])
  
  planQty     Float
  pickedQty   Float          @default(0)
  
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  
  @@map("outbound_tasks")
}

// ==========================================
// 6. Documents (PO & MO)
// ==========================================

model PurchaseOrder {
  id          String   @id // PO_NO
  supplierId  String?
  supplier    Supplier? @relation(fields: [supplierId], references: [id])
  
  orderDate   DateTime?
  dueDate     DateTime?
  orderType   String?
  currency    String?
  vatRate     Float?
  status      String   @default("OPEN")
  
  items       PurchaseOrderItem[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id          String   @id @default(cuid())
  poId        String
  partId      String
  
  orderQty    Float
  receivedQty Float  @default(0)
  unitPrice   Float?
  totalAmount Float?
  
  po           PurchaseOrder @relation(fields: [poId], references: [id], onDelete: Cascade)
  part         Part     @relation(fields: [partId], references: [id])
  inboundTasks InboundTask[]
  @@map("purchase_order_items")
}

model ProductionOrder {
  id          String   @id // MONO
  parentItem  String
  parentName  String?
  model       String?
  planQty     Float
  status      String   @default("OPEN")
  
  line        String?
  workCenter  String?
  
  startDate   DateTime?
  endDate     DateTime?
  
  bomItems    BOMItem[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  @@map("production_orders")
}

model BOMItem {
  id                String          @id @default(cuid())
  productionOrderId String
  partId            String
  part              Part            @relation(fields: [partId], references: [id])
  
  requiredQty       Float
  pickedQty         Float           @default(0)
  
  productionOrder   ProductionOrder @relation(fields: [productionOrderId], references: [id], onDelete: Cascade)
  outboundTasks     OutboundTask[]  // Reserved for future picking system
  @@map("bom_items")
}

// ==========================================
// 7. QC
// ==========================================

model InspectionResult {
  id            String       @id @default(uuid())
  inboundTaskId String       @unique
  inboundTask   InboundTask  @relation(fields: [inboundTaskId], references: [id])
  passedQty     Float
  failedQty     Float
  judgment      String
  defectReason  String?
  remark        String?
  inspector     String?
  createdAt     DateTime     @default(now())
  @@map("inspection_results")
}
model invoice {
  id           Int      @id @default(autoincrement())
  po           String
  vendor       String?
  partNo       String
  partName     String
  invoice      String
  invoiceDate  String?
  receivedDate String?
  qty          Int
  timestamp    String
  createdAt    DateTime @default(now())
  recordedBy   String?
  iqcstatus    String   @default("Pending")
  samplingType String?
  aql          String?
  totalSampling Int?

  @@map("invoices")
}
